#!/bin/bash
#/*****************************************************************************
# *  Filename:  setenv.sh
# *
# *  FILE HISTORY
# *=========================================================================
# * DATE         Author               Details
# *=========================================================================
# * 21/07/2020   Tanmay Prakash       Initial Draft
# *
# *  Copyright (c) tanmayp1192@gmail.com.
# ****************************************************************************/


#*****************************************************************************
#                          INIT VARIABLE
#*****************************************************************************

function init_var() {
   GLOBAL_JS_CONFIG_FILE="./assets/globalconf.js"
   ENV_FILE="./assets/.env"
   ENV_DELIM="="
   TODAY=`date +%Y-%m-%d.%H:%M:%S`
}

#*****************************************************************************
#                   READ .env AND CREATE GLOBAL JS FILE
#*****************************************************************************

function read_env() {
   # Remove existing global js file
   rm -rf $GLOBAL_JS_CONFIG_FILE
   touch $GLOBAL_JS_CONFIG_FILE

   local file_data=""
   local file_header=$( printf '%s\n'\
                     "/***" \
                     "* This File Is Auto Generated By Deployment Script" \
                     "* @date: $TODAY" \
                     "* @author: Tanmay Prakash" \
                     "*/" )
   ###
   # Sample globalconf.js :
   # -----------
   #        window._app_env_ = {
   #         API_URL: http://localhost:9090
   #        };
   ##
   while read -r line || [[ -n "$line" ]];
   do

     if printf '%s\n' "$line" | grep -q -e $ENV_DELIM; then
       key=$(echo "$line" | sed -e 's/${ENV_DELIM}.*//')
       value=$(echo "$line" | sed -e 's/^[^${ENV_DELIM}]*${ENV_DELIM}//')
     fi

     if [[ -z $value && -z $key ]];then
       echo "  $key: \"$value\"," >> $file_data
     fi

   done <  $ENV_FILE

   # Append configuration
   echo $file_header > $GLOBAL_JS_CONFIG_FILE
   echo "window._app_env_ = {" >> $GLOBAL_JS_CONFIG_FILE
   echo $file_data >> $GLOBAL_JS_CONFIG_FILE
   echo "};" >> $GLOBAL_JS_CONFIG_FILE
}

#*****************************************************************************
#                              MAIN
#*****************************************************************************

# Initial all global variables
init_var

# Read .env file
read_env